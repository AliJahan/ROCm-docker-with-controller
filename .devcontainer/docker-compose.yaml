version: "3.8"

services:
  freq-reg:
    image: freq-reg:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.frequency-regulator-centos7
    stdin_open: true
    tty: true
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    working_dir: /workspace
    command: /bin/bash
    network_mode: "host"
  experiment-runner:
    image: experiment-runner:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.experiment-runner-centos7
    stdin_open: true
    tty: true
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    working_dir: /workspace
    command: /bin/bash
    network_mode: "host"

  rocm-ubuntu: # rocm-ubuntu: rocm-5.7.1 installed on ubuntu 20.04
    image: rocm5.7.1-ubuntu20.04:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.rocm5.7.1-ubuntu20.04
    stdin_open: true
    tty: true
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
  remote-rocm-ubuntu: # ROCR-Runtime modified to control cumasking remotely
    image: remote-rocm-ubuntu:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.remote-rocm-ubuntu
    stdin_open: true
    tty: true
    environment:
      - REMOTE_IP=${REMOTE_IP}
      - WORKLOAD_CONTROLLER_PORT=${WORKLOAD_CONTROLLER_PORT}
      - RESOURCE_CONTROLLER_PORT=${RESOURCE_CONTROLLER_PORT}
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
    # ports:
    #   - "9090:9090"
    network_mode: "host"
  tvm-remote-rocm-ubuntu: # tvm-unity and pytorch 2.1 installed on remotely controllable (cumasking) rocm
    image: tvm-remote-rocm-ubuntu:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.tvm-torch-remote-rocm
    stdin_open: true
    tty: true
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
    # ports:
    #   - "9090:9090"
    network_mode: "host"
  Inference-Server: # contains gpu workloads on remotely controllable rocm
    image: inference-server-remote-rocm-ubuntu:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.gpu-workloads-remote-rocm
    stdin_open: true
    tty: true
    environment:
      - WORKLOAD=Inference-Server
      - REMOTE_IP=${REMOTE_IP}
      - WORKLOAD_CONTROLLER_PORT=${WORKLOAD_CONTROLLER_PORT}
      - RESOURCE_CONTROLLER_PORT=${RESOURCE_CONTROLLER_PORT}
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
    # ports:
    #   - "9090:9090"
    network_mode: "host"
  miniMDock: # contains gpu workloads on remotely controllable rocm
    image: minimdock-remote-rocm-ubuntu:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.gpu-workloads-remote-rocm
    stdin_open: true
    tty: true
    environment:
      - WORKLOAD=miniMDock
      - REMOTE_IP=${REMOTE_IP}
      - WORKLOAD_CONTROLLER_PORT=${WORKLOAD_CONTROLLER_PORT}
      - RESOURCE_CONTROLLER_PORT=${RESOURCE_CONTROLLER_PORT}
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
    # ports:
    #   - "9090:9090"
    network_mode: "host"
  power-broadcaster: 
    image: power-broadcaster-rocm:latest
    build:
      context: ..
      dockerfile: ./.devcontainer/Dockerfile.power-broadcaster
    stdin_open: true
    tty: true
    volumes:
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
      - ../:/workspace
    devices:
      - "/dev/kfd:/dev/dri"
    privileged: true
    working_dir: /workspace
    command: /bin/bash
    profiles: ["amd"]
    network_mode: "host"